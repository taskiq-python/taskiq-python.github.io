import{_ as c}from"./plugin-vue_export-helper-c27b6911.js";import{r as o,o as l,c as r,e as a,b as n,d as s,w as u,a as e}from"./app-59ee3ce3.js";const d={},k=e('<h1 id="architecture-overview" tabindex="-1"><a class="header-anchor" href="#architecture-overview" aria-hidden="true">#</a> Architecture overview</h1><p>Taskiq has very simple structure. On the client side all messages are sent by <code>kickers</code> using <code>brokers</code>. On the worker side all messages received by the <code>broker</code> and results are stored in result backends.</p><p>On the sequence diagram it looks like this:</p><div class="hint-container info"><p class="hint-container-title">Cool tip!</p><p>If you use dark theme and cannot see words on diagram, try switching to light theme and back to dark.</p></div>',4),m=n("p",null,"Let's discuss every component.",-1),v=n("h2",{id:"broker",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#broker","aria-hidden":"true"},"#"),s(" Broker")],-1),b=n("strong",null,"must",-1),h=n("code",null,"AsyncBroker",-1),y={href:"https://github.com/taskiq-python/taskiq/blob/master/taskiq/abc/broker.py",target:"_blank",rel:"noopener noreferrer"},g=e(`<p><code>AsyncBroker</code> class has two main methods to implement:</p><ul><li>kick</li><li>listen</li></ul><p>The <code>kick</code> method puts the message in the external system. For example, it may call the <code>PUB</code> command in Redis.</p><p>The <code>listen</code> is a method with an infinite loop that reads messages from the external system and creates a task for processing messages. For example, it subscribes to the Redis channel and waits for new messages.</p><h2 id="kicker" tabindex="-1"><a class="header-anchor" href="#kicker" aria-hidden="true">#</a> Kicker</h2><p>Kicker is an object that used to form a message for broker. This class isn&#39;t extendable. To form a message kicker uses labels, task name and arguments.</p><p>When you call the <code>task.kiq</code> on a task, it generates a Kicker instance and is a shortening for the <code>task.kicker().kiq(...)</code>. You can use kicker to change broker, add labels, or even change task_id.</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">import</span> asyncio

<span class="token keyword">from</span> taskiq<span class="token punctuation">.</span>brokers<span class="token punctuation">.</span>inmemory_broker <span class="token keyword">import</span> InMemoryBroker

broker <span class="token operator">=</span> InMemoryBroker<span class="token punctuation">(</span><span class="token punctuation">)</span>
second_broker <span class="token operator">=</span> InMemoryBroker<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@broker<span class="token punctuation">.</span>task</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">my_async_task</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;My lovely task.&quot;&quot;&quot;</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">)</span>


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># This task was initially assigned to broker,</span>
    <span class="token comment"># but this time it is going to be sent using</span>
    <span class="token comment"># the second broker with additional label \`delay=1\`.</span>
    task <span class="token operator">=</span> <span class="token keyword">await</span> my_async_task<span class="token punctuation">.</span>kicker<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>with_broker<span class="token punctuation">(</span>second_broker<span class="token punctuation">)</span><span class="token punctuation">.</span>with_labels<span class="token punctuation">(</span>delay<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>kiq<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token keyword">await</span> task<span class="token punctuation">.</span>get_result<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="messages" tabindex="-1"><a class="header-anchor" href="#messages" aria-hidden="true">#</a> Messages</h2><p>Every message has labels. You can define labels using <code>task</code> decorator, or you can add them using kicker.</p><p>For example:</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code>
<span class="token decorator annotation punctuation">@broker<span class="token punctuation">.</span>task</span><span class="token punctuation">(</span>my_label<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> label2<span class="token operator">=</span><span class="token string">&quot;something&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">my_async_task</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;My lovely task.&quot;&quot;&quot;</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">await</span> my_async_task<span class="token punctuation">.</span>kiq<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>It&#39;s equivalent to this</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code>
<span class="token decorator annotation punctuation">@broker<span class="token punctuation">.</span>task</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">my_async_task</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;My lovely task.&quot;&quot;&quot;</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">await</span> my_async_task<span class="token punctuation">.</span>kicker<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>with_labels<span class="token punctuation">(</span>
        my_label<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
        label2<span class="token operator">=</span><span class="token string">&quot;something&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">.</span>kiq<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Also you can assign custom task names using decorator. This is useful to be sure that task names are unique and resolved correctly. Also it may be useful to balance message routing in some brokers.</p><p>for example:</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token decorator annotation punctuation">@broker<span class="token punctuation">.</span>task</span><span class="token punctuation">(</span>task_name<span class="token operator">=</span><span class="token string">&quot;my_tasks.add_one&quot;</span><span class="token punctuation">,</span> label1<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">my_async_task</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;My lovely task.&quot;&quot;&quot;</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">)</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="result-backend" tabindex="-1"><a class="header-anchor" href="#result-backend" aria-hidden="true">#</a> Result backend</h2>`,18),w=n("code",null,"TaskiqResult",-1),f={href:"https://github.com/taskiq-python/taskiq/blob/master/taskiq/result.py",target:"_blank",rel:"noopener noreferrer"},q=n("code",null,"AsyncResultBackend",-1),_={href:"https://github.com/taskiq-python/taskiq/blob/master/taskiq/abc/result_backend.py",target:"_blank",rel:"noopener noreferrer"},x=n("code",null,"DummyResultBackend",-1),M=n("code",null,"InMemoryBroker",-1),T=n("code",null,"InMemoryResultBackend",-1),B=e(`<h2 id="workers" tabindex="-1"><a class="header-anchor" href="#workers" aria-hidden="true">#</a> Workers</h2><p>Taskiq has a command line interface to run workers. It&#39;s simple to get it to work.</p><p>You have to provide a path to your broker. As an example, if you want to start listening to new tasks with a broker that is stored in a variable <code>my broker</code> in the module <code>my_project.broker</code> run this in your terminal:</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>taskiq worker my_project.broker:mybroker
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>taskiq can discover task modules to import automatically, if you add the <code>-fsd</code> (file system discover) option.</p><p>Let&#39;s assume we have project with the following structure:</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>test_project
├── broker.py
├── submodule
│   └── tasks.py
└── utils
    └── tasks.py
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>You can specify all tasks modules to import manually.</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>taskiq worker test_project.broker:broker test_project.submodule.tasks test_project.utils.tasks
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>Or you can let taskiq find all python modules named tasks in current directory recursively.</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>taskiq worker test_project.broker:broker <span class="token parameter variable">-fsd</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div>`,11),I=e(`<div class="hint-container info"><p class="hint-container-title">Cool info</p><p>By default we start two processes, if you want to change this value, please take a look at <code>--help</code>.</p></div><h2 id="middlewares" tabindex="-1"><a class="header-anchor" href="#middlewares" aria-hidden="true">#</a> Middlewares</h2><p>Middlewares are used to modify message, or take some actions before or after task is complete.</p><p>You can write your own middlewares by subclassing the <code>taskiq.abc.middleware.TaskiqMiddleware</code>.</p><p>Every hook can be sync or async. Taskiq will execute it.</p><p>For example, this is a valid middleware.</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">import</span> asyncio

<span class="token keyword">from</span> taskiq<span class="token punctuation">.</span>abc<span class="token punctuation">.</span>middleware <span class="token keyword">import</span> TaskiqMiddleware
<span class="token keyword">from</span> taskiq<span class="token punctuation">.</span>message <span class="token keyword">import</span> TaskiqMessage


<span class="token keyword">class</span> <span class="token class-name">MyMiddleware</span><span class="token punctuation">(</span>TaskiqMiddleware<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">pre_send</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> message<span class="token punctuation">:</span> <span class="token string">&quot;TaskiqMessage&quot;</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> TaskiqMessage<span class="token punctuation">:</span>
        <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        message<span class="token punctuation">.</span>labels<span class="token punctuation">[</span><span class="token string">&quot;my_label&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;my_value&quot;</span>
        <span class="token keyword">return</span> message

    <span class="token keyword">def</span> <span class="token function">post_send</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> message<span class="token punctuation">:</span> <span class="token string">&quot;TaskiqMessage&quot;</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Message </span><span class="token interpolation"><span class="token punctuation">{</span>message<span class="token punctuation">}</span></span><span class="token string"> was sent.&quot;</span></span><span class="token punctuation">)</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Here are methods you can implement in the order they are executed:</p><ul><li><code>pre_send</code> - executed on the client side before the message is sent. Here you can modify the message.</li><li><code>post_send</code> - executed right after the message was sent.</li><li><code>pre_execute</code> - executed on the worker side after the message was received by a worker and before its execution.</li><li><code>on_error</code> - executed after the task was executed if the exception was found.</li><li><code>post_execute</code> - executed after the message was executed.</li><li><code>post_save</code> - executed after the result was saved in the result backend.</li></ul><p>You can use sync or async hooks without changing anything, but adding async to the hook signature.</p><div class="hint-container warning"><p class="hint-container-title">important note</p><p>If exception happens in middlewares it won&#39;t be caught. Please ensure that you have try\\except for all edge cases of your middleware.</p></div><p>Middlewares can store information in <code>message.labels</code> for later use. For example <code>SimpleRetryMiddleware</code> uses labels to remember number of failed attempts.</p><h2 id="context" tabindex="-1"><a class="header-anchor" href="#context" aria-hidden="true">#</a> Context</h2><p>Context is a useful class with some additional functions. You can use context to get broker that runs this task, from inside of the task.</p><p>Or it has ability to control the flow of execution. Here&#39;s example of how to get the context.</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">from</span> taskiq <span class="token keyword">import</span> Context<span class="token punctuation">,</span> TaskiqDepends<span class="token punctuation">,</span> ZeroMQBroker

broker <span class="token operator">=</span> ZeroMQBroker<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@broker<span class="token punctuation">.</span>task</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">my_task</span><span class="token punctuation">(</span>context<span class="token punctuation">:</span> Context <span class="token operator">=</span> TaskiqDepends<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Also through contexts you can reject or requeue a task. It&#39;s easy as this:</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token decorator annotation punctuation">@broker<span class="token punctuation">.</span>task</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">my_task</span><span class="token punctuation">(</span>context<span class="token punctuation">:</span> Context <span class="token operator">=</span> TaskiqDepends<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
   <span class="token keyword">await</span> context<span class="token punctuation">.</span>requeue<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Calling <code>requeue</code> or <code>reject</code> stops task execution and either drops the message, or puts it back to the queue.</p><p>Also, with context you&#39;ll be able to get current message that was received by the broker or even instance of a broker who received a message. This may be useful for lib developers.</p>`,20);function A(j,R){const i=o("Mermaid"),t=o("ExternalLinkIcon"),p=o("RouterLink");return l(),r("div",null,[k,a(i,{id:"mermaid-14",code:"eJyVkL0OwjAMhHeewiNIgASIAQYGfiYmYECMaXqUiDYRToJ4fEygqGVjiZTc57tzPG4RVmNtVMGq6hAxdCAusu5oNurTeDyRYzrtiWJdALEpLoHcmU4uMmmXY06r0sAG8ibHULivQoPFgrZGX8FzUt6jykpQBe9VAQHfUqKW7BJ1gM0bhNz+qFSbHB2/fOs+7+cUs3kEsFUl7SKiNP+Ja8utYntomPsLatjV4uYBHaVJUP7aJvbwsQyUKdnU5hKo7oJdpHQSviu2uTTa+OBPeHPwCc7mjN4="}),m,v,n("p",null,[s("Brokers are the most critical element of the taskiq. Every broker "),b,s(" implement the "),h,s(" abstract class from "),n("a",y,[s("taskiq.abc.broker"),a(t)]),s(" to make things work.")]),g,n("p",null,[s("Result backend is used to store and get results of the execution. Results have type "),w,s(" from "),n("a",f,[s("taskiq.result"),a(t)]),s(".")]),n("p",null,[s("Every ResultBackend must implement "),q,s(" from "),n("a",_,[s("taskiq.abc.result_backend"),a(t)]),s(". By default, brokers use "),x,s(". It doesn't do anything and cannot be used in real-world scenarios. But some brokers can override it. For example "),M,s(" by default uses "),T,s(" and returns correct results.")]),B,n("p",null,[s("If you have uvloop installed, taskiq will automatically install new policies to event loop. You can get more info about the CLI in the "),a(p,{to:"/guide/cli.html"},{default:u(()=>[s("CLI")]),_:1}),s(" section.")]),I])}const H=c(d,[["render",A],["__file","architecture-overview.html.vue"]]);export{H as default};
