import{_ as c}from"./_plugin-vue_export-helper.cdc0426e.js";import{o as l,c as r,e as a,b as n,w as u,a as e,d as s,r as o}from"./app.c40460fb.js";const d={},k=e('<h1 id="architecture-overview" tabindex="-1"><a class="header-anchor" href="#architecture-overview" aria-hidden="true">#</a> Architecture overview</h1><p>Taskiq has very simple structure. On the client side all messages are sent by <code>kickers</code> using <code>brokers</code>. On the worker side all messages received by the <code>broker</code> and results are stored in result backends.</p><p>On the sequence diagram it looks like this:</p><div class="custom-container info"><p class="custom-container-title">cool tip</p><p>If you use dark theme and cannot see words on diagram, try switching to light theme and back to dark.</p></div>',4),m=n("p",null,"Let's discuss every component.",-1),v=n("h2",{id:"broker",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#broker","aria-hidden":"true"},"#"),s(" Broker")],-1),b=s("Brokers are the most critical element of the taskiq. Every broker "),h=n("strong",null,"must",-1),y=s(" implement the "),g=n("code",null,"AsyncBroker",-1),_=s(" abstract class from "),w={href:"https://github.com/taskiq-python/taskiq/blob/master/taskiq/abc/broker.py",target:"_blank",rel:"noopener noreferrer"},f=s("taskiq.abc.broker"),q=s(" to make things work."),x=e(`<p><code>AsyncBroker</code> class has two main methods to implement:</p><ul><li>kick</li><li>listen</li></ul><p>The <code>kick</code> method puts the message in the external system. For example, it may call the <code>PUB</code> command in Redis.</p><p>The <code>listen</code> is a method with an infinite loop that reads messages from the external system and creates a task for processing messages. For example, it subscribes to the Redis channel and waits for new messages.</p><h2 id="kicker" tabindex="-1"><a class="header-anchor" href="#kicker" aria-hidden="true">#</a> Kicker</h2><p>Kicker is an object that used to form a message for broker. This class isn&#39;t extendable. To form a message kicker uses labels, task name and arguments.</p><p>When you call the <code>task.kiq</code> on a task, it generates a Kicker instance and is a shortening for the <code>task.kicker().kiq(...)</code>. You can use kicker to change broker, add labels, or even change task_id.</p><div class="language-python ext-py line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> asyncio

<span class="token keyword">from</span> taskiq<span class="token punctuation">.</span>brokers<span class="token punctuation">.</span>inmemory_broker <span class="token keyword">import</span> InMemoryBroker

broker <span class="token operator">=</span> InMemoryBroker<span class="token punctuation">(</span><span class="token punctuation">)</span>
second_broker <span class="token operator">=</span> InMemoryBroker<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@broker<span class="token punctuation">.</span>task</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">my_async_task</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;My lovely task.&quot;&quot;&quot;</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">)</span>


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># This task was initially assigned to broker,</span>
    <span class="token comment"># but this time it is going to be sent using</span>
    <span class="token comment"># the second broker with additional label \`delay=1\`.</span>
    task <span class="token operator">=</span> <span class="token keyword">await</span> my_async_task<span class="token punctuation">.</span>kicker<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>with_broker<span class="token punctuation">(</span>second_broker<span class="token punctuation">)</span><span class="token punctuation">.</span>with_labels<span class="token punctuation">(</span>delay<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>kiq<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token keyword">await</span> task<span class="token punctuation">.</span>get_result<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="result-backend" tabindex="-1"><a class="header-anchor" href="#result-backend" aria-hidden="true">#</a> Result backend</h2>`,9),A=s("This part is used to store and get results of the execution. Results have type "),M=n("code",null,"TaskiqResult",-1),B=s(" from "),E={href:"https://github.com/taskiq-python/taskiq/blob/master/taskiq/result.py",target:"_blank",rel:"noopener noreferrer"},T=s("taskiq.result"),R=s("."),I=s("Every ResultBackend must implement "),C=n("code",null,"AsyncResultBackend",-1),j=s(" from "),Y={href:"https://github.com/taskiq-python/taskiq/blob/master/taskiq/abc/result_backend.py",target:"_blank",rel:"noopener noreferrer"},N=s("taskiq.abc.result_backend"),L=s(". By default, brokers use "),F=n("code",null,"DummyResultBackend",-1),H=s(". It doesn't do anything and cannot be used in real-world scenarios. But some brokers can override it. For example "),K=n("code",null,"InMemoryBroker",-1),O=s(" by default uses "),S=n("code",null,"InMemoryResultBackend",-1),V=s(" and returns correct results."),W=e(`<h2 id="workers" tabindex="-1"><a class="header-anchor" href="#workers" aria-hidden="true">#</a> Workers</h2><p>Taskiq has a command line interface to run workers. It&#39;s simple to get it to work.</p><p>You have to provide a path to your broker. As an example, if you want to start listening to new tasks with a broker that is stored in a variable <code>my broker</code> in the module <code>my_project.broker</code> run this in your terminal:</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>taskiq my_project.broker:mybroker
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>taskiq can discover task modules to import automatically, if you add the <code>-fsd</code> (file system discover) option.</p><p>Let&#39;s assume we have project with the following structure:</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>test_project
\u251C\u2500\u2500 broker.py
\u251C\u2500\u2500 submodule
\u2502   \u2514\u2500\u2500 tasks.py
\u2514\u2500\u2500 utils
    \u2514\u2500\u2500 tasks.py
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>You can specify all tasks modules to import manually.</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>taskiq test_project.broker:broker test_projec.submodule.tasks test_projec.utils.tasks
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>Or you can let taskiq find all python modules named tasks in current directory recursively.</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>taskiq test_project.broker:broker <span class="token parameter variable">-fsd</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div>`,11),P=s("If you have uvloop installed, taskiq will automatically install new policies to event loop. You can get more info about the CLI in the "),D=s("CLI"),Q=s(" section."),U=e(`<h2 id="middlewares" tabindex="-1"><a class="header-anchor" href="#middlewares" aria-hidden="true">#</a> Middlewares</h2><p>Middlewares are used to modify message, or take some actions before or after task is complete.</p><p>You can write your own middlewares by subclassing the <code>taskiq.abc.middleware.TaskiqMiddleware</code>.</p><p>Every hook can be sync or async. Taskiq will execute it.</p><p>For example, this is a valid middleware.</p><div class="language-python ext-py line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> asyncio

<span class="token keyword">from</span> taskiq<span class="token punctuation">.</span>abc<span class="token punctuation">.</span>middleware <span class="token keyword">import</span> TaskiqMiddleware
<span class="token keyword">from</span> taskiq<span class="token punctuation">.</span>message <span class="token keyword">import</span> TaskiqMessage


<span class="token keyword">class</span> <span class="token class-name">MyMiddleware</span><span class="token punctuation">(</span>TaskiqMiddleware<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">pre_send</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> message<span class="token punctuation">:</span> <span class="token string">&quot;TaskiqMessage&quot;</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> TaskiqMessage<span class="token punctuation">:</span>
        <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        message<span class="token punctuation">.</span>labels<span class="token punctuation">[</span><span class="token string">&quot;my_label&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;my_value&quot;</span>
        <span class="token keyword">return</span> message

    <span class="token keyword">def</span> <span class="token function">post_send</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> message<span class="token punctuation">:</span> <span class="token string">&quot;TaskiqMessage&quot;</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Message </span><span class="token interpolation"><span class="token punctuation">{</span>message<span class="token punctuation">}</span></span><span class="token string"> was sent.&quot;</span></span><span class="token punctuation">)</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Here are methods you can implement in the order they are executed:</p><ul><li><code>pre_send</code> - executed on the client side before the message is sent. Here you can modify the message.</li><li><code>post_send</code> - executed right after the message was sent.</li><li><code>pre_execute</code> - executed on the worker side after the message was received by a worker and before its execution.</li><li><code>on_error</code> - executed after the task was executed if the exception was found.</li><li><code>post_execute</code> - executed after the message was executed.</li><li><code>post_save</code> - executed after the result was saved in the result backend.</li></ul><p>You can use sync or async hooks without changing aything, but adding async to the hook signature.</p><div class="custom-container warning"><p class="custom-container-title">important note</p><p>If excetion happens in middlewares it won&#39;t be caught. Please ensure that you have try\\except for all edge cases of your middleware.</p></div><p>Middlewares can store information in <code>message.labels</code> for later use. For example <code>SimpleRetryMiddleware</code> uses labels to remember number of failed attempts.</p><h2 id="messages" tabindex="-1"><a class="header-anchor" href="#messages" aria-hidden="true">#</a> Messages</h2><p>Every message has labels. You can define labels using <code>task</code> decorator, or you can add them using kicker.</p><p>For example:</p><div class="language-python ext-py line-numbers-mode"><pre class="language-python"><code>
<span class="token decorator annotation punctuation">@broker<span class="token punctuation">.</span>task</span><span class="token punctuation">(</span>my_label<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> label2<span class="token operator">=</span><span class="token string">&quot;something&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">my_async_task</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;My lovely task.&quot;&quot;&quot;</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">await</span> my_async_task<span class="token punctuation">.</span>kiq<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>It&#39;s equivalent to this</p><div class="language-python ext-py line-numbers-mode"><pre class="language-python"><code>
<span class="token decorator annotation punctuation">@broker<span class="token punctuation">.</span>task</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">my_async_task</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;My lovely task.&quot;&quot;&quot;</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">await</span> my_async_task<span class="token punctuation">.</span>kicker<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>with_labels<span class="token punctuation">(</span>
        my_label<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
        label2<span class="token operator">=</span><span class="token string">&quot;something&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">.</span>kiq<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Also you can assign custom task names using decorator. This is useful to be sure that task names are unique and resolved correctly. Also it may be useful to balance message routing in some brokers.</p><p>for example:</p><div class="language-python ext-py line-numbers-mode"><pre class="language-python"><code><span class="token decorator annotation punctuation">@broker<span class="token punctuation">.</span>task</span><span class="token punctuation">(</span>task_name<span class="token operator">=</span><span class="token string">&quot;my_tasks.add_one&quot;</span><span class="token punctuation">,</span> label1<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">my_async_task</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;My lovely task.&quot;&quot;&quot;</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">)</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="context" tabindex="-1"><a class="header-anchor" href="#context" aria-hidden="true">#</a> Context</h2><p>This section is useful for library developers. Who want to get current broker during shared task execution.</p><p>For example, you&#39;ve created shared_task and you want to send message in that task. This can be done with context.</p><p>Context holds information about the current broker and current incoming message. To get it, simply add the context parameter with <code>type-hint</code>.</p><div class="custom-container warning"><p class="custom-container-title">cool warning</p><p>Context injected only if you have a type hint.</p></div><p>Example:</p><div class="language-python ext-py line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> taskiq <span class="token keyword">import</span> async_shared_broker<span class="token punctuation">,</span> BrokerMessage<span class="token punctuation">,</span> Context


<span class="token decorator annotation punctuation">@async_shared_broker<span class="token punctuation">.</span>task</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">my_shr_task</span><span class="token punctuation">(</span>context<span class="token punctuation">:</span> Context<span class="token punctuation">)</span><span class="token punctuation">:</span>
    message <span class="token operator">=</span> BrokerMessage<span class="token punctuation">(</span>
        task_id<span class="token operator">=</span><span class="token string">&quot;123&quot;</span><span class="token punctuation">,</span>
        task_name<span class="token operator">=</span><span class="token string">&quot;dummy_name&quot;</span><span class="token punctuation">,</span>
        message<span class="token operator">=</span><span class="token string">&#39;{&quot;one&quot;: &quot;two&quot;}&#39;</span><span class="token punctuation">,</span>
        labels<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">await</span> context<span class="token punctuation">.</span>broker<span class="token punctuation">.</span>kick<span class="token punctuation">(</span>message<span class="token punctuation">)</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>This is useless example, but it&#39;s good as a demonstration. Pipelines are built using this magic.</p>`,28);function z(G,J){const i=o("Mermaid"),t=o("ExternalLinkIcon"),p=o("RouterLink");return l(),r("div",null,[k,a(i,{id:"mermaid-382ee149",code:"sequenceDiagram%0A%20%20rect%20rgb(191%2C%20223%2C%20255)%0A%20%20note%20right%20of%20Your%20code%3A%20Client%20side.%0A%20%20Your%20code%20-%3E%3E%20Kicker%3A%20assemble%20message%0A%20%20Kicker%20-%3E%3E%20Broker%3A%20Send%20message%0A%20%20end%0A%20%20rect%20rgb(191%2C%20223%2C%20255)%0A%20%20note%20right%20of%20Broker%3A%20Worker%20side.%0A%20%20Broker%20-%3E%3E%20External%20Queue%3A%20Send%20message%0A%20%20External%20Queue%20-%3E%3E%20Broker%3A%20Receive%0A%20%20Broker%20-%3E%3E%20Broker%3A%20Execute%20task%0A%20%20Broker%20-%3E%3E%20Result%20backend%3A%20Save%20the%20result%0A%20%20end%0A%20%20Result%20backend%20-%3E%3E%20Your%20code%3A%20Receive%20the%20result%0A"}),m,v,n("p",null,[b,h,y,g,_,n("a",w,[f,a(t)]),q]),x,n("p",null,[A,M,B,n("a",E,[T,a(t)]),R]),n("p",null,[I,C,j,n("a",Y,[N,a(t)]),L,F,H,K,O,S,V]),W,n("p",null,[P,a(p,{to:"/guide/cli.html"},{default:u(()=>[D]),_:1}),Q]),U])}const $=c(d,[["render",z],["__file","architecture-overview.html.vue"]]);export{$ as default};
