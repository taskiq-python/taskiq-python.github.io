import{_ as n,W as s,X as a,Y as e}from"./framework-324439bb.js";const t={},o=e(`<h1 id="brokers" tabindex="-1"><a class="header-anchor" href="#brokers" aria-hidden="true">#</a> Brokers</h1><p>To add a new broker you need to implement two methods <code>kick</code> and <code>listen</code> of the <code>taskiq.abc.broker.AsyncBroker</code> abstract class. But along with them we have helper methods. Such as shutdown and startup.</p><p>Here is a template for new brokers:</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">from</span> typing <span class="token keyword">import</span> AsyncGenerator

<span class="token keyword">from</span> taskiq <span class="token keyword">import</span> AsyncBroker<span class="token punctuation">,</span> BrokerMessage


<span class="token keyword">class</span> <span class="token class-name">MyBroker</span><span class="token punctuation">(</span>AsyncBroker<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token comment"># Please call this super method to set default values to</span>
        <span class="token comment"># many different fields.</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">startup</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token comment"># Here you can do some startup magic.</span>
        <span class="token comment"># Like opening a connection.</span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>startup<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">shutdown</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token comment"># Here you can perform shutdown operations.</span>
        <span class="token comment"># Like closing connections.</span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>shutdown<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">kick</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> message<span class="token punctuation">:</span> BrokerMessage<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token comment"># Send a message.message.</span>
        <span class="token keyword">pass</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">listen</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> AsyncGenerator<span class="token punctuation">[</span><span class="token builtin">bytes</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            <span class="token comment"># Get new message.</span>
            new_message<span class="token punctuation">:</span> <span class="token builtin">bytes</span> <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  <span class="token comment"># type: ignore</span>
            <span class="token comment"># Yield it!</span>
            <span class="token keyword">yield</span> new_message
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="about-kick-and-listen" tabindex="-1"><a class="header-anchor" href="#about-kick-and-listen" aria-hidden="true">#</a> About kick and listen</h1><p>The <code>kick</code> method takes a <code>BrokerMessage</code> as a parameter. The <code>BrokerMessage</code> class is a handy helper class for brokers. You can use information from the BrokerMessage to alter the delivery method.</p><div class="hint-container warning"><p class="hint-container-title">&quot;cool warning!&quot;</p><p>As a broker developer, please send only raw bytes from the <code>message</code> field of a BrokerMessage if possible. Serializing it to the string may result in a problem if message bytes are not utf-8 compatible.</p></div><p>The <code>listen</code> method should yield raw bytes that were sent over the network.</p><h2 id="conventions" tabindex="-1"><a class="header-anchor" href="#conventions" aria-hidden="true">#</a> Conventions</h2><p>For brokers, we have several conventions. It&#39;s good if your broker implements them. These rules are optional, and it&#39;s ok if your broker doesn&#39;t implement them.</p><ol><li>If the message has the <code>delay</code> label with int or float number, this task&#39;s <code>execution</code> must be delayed with the same number of seconds as in the delay label.</li><li>If the message has the <code>priority</code> label, this message must be sent with priority. Tasks with higher priorities are executed sooner.</li></ol>`,11),p=[o];function c(i,l){return s(),a("div",null,p)}const d=n(t,[["render",c],["__file","broker.html.vue"]]);export{d as default};
