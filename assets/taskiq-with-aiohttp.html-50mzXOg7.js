import{_ as r}from"./plugin-vue_export-helper-x3n3nnut.js";import{r as l,o as d,c as u,b as n,d as e,e as a,w as t,a as p}from"./app-Lulzgzf0.js";const k={},m=n("h1",{id:"taskiq-aiohttp",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#taskiq-aiohttp"},[n("span",null,"Taskiq + AioHTTP")])],-1),v=n("p",null,"AioHTTP is a framework for building robust applications. We created several libraries to make the experience with AioHTTP even better.",-1),h=n("h1",{id:"dependency-injection-for-aiohttp",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#dependency-injection-for-aiohttp"},[n("span",null,"Dependency injection for AioHTTP")])],-1),b={href:"https://pypi.org/project/aiohttp-deps/",target:"_blank",rel:"noopener noreferrer"},y=p(`<p>To install it, simply run:</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code>pip install <span class="token string">&quot;aiohttp-deps&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>After the installation, please add startup event to your application to initialize dependencies context.</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token keyword">from</span> aiohttp <span class="token keyword">import</span> web
<span class="token keyword">import</span> aiohttp_deps


app <span class="token operator">=</span> web<span class="token punctuation">.</span>Application<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># This startup event makes all the magic happen.</span>
<span class="token comment"># It parses current handlers and create dependency graphs for them.</span>
app<span class="token punctuation">.</span>on_startup<span class="token punctuation">.</span>append<span class="token punctuation">(</span>aiohttp_deps<span class="token punctuation">.</span>init<span class="token punctuation">)</span>

web<span class="token punctuation">.</span>run_app<span class="token punctuation">(</span>app<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,4),g={href:"https://github.com/taskiq-python/aiohttp-deps",target:"_blank",rel:"noopener noreferrer"},f=n("h2",{id:"adding-taskiq-integration",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#adding-taskiq-integration"},[n("span",null,"Adding taskiq integration")])],-1),_={href:"https://pypi.org/project/taskiq-aiohttp/",target:"_blank",rel:"noopener noreferrer"},T=p(`<div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code>pip install <span class="token string">&quot;taskiq-aiohttp&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>After the installation is complete, add an initialization function call to your broker&#39;s main file so it becomes something like this:</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token keyword">import</span> taskiq_aiohttp

broker <span class="token operator">=</span> MyBroker<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># The second argument is a path to web.Application variable.</span>
<span class="token comment"># Also you can provide here a factory function that takes no</span>
<span class="token comment"># arguments and returns an application. This function can be async.</span>
taskiq_aiohttp<span class="token punctuation">.</span>init<span class="token punctuation">(</span>broker<span class="token punctuation">,</span> <span class="token string">&quot;my_project.main:app&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>From this point, you&#39;ll be able to reuse the same dependencies as with <code>aiohttp-deps</code>. Let&#39;s take a look at this function:</p>`,4),w=n("div",{class:"language-python line-numbers-mode","data-ext":"py","data-title":"py"},[n("pre",{class:"language-python"},[n("code",null,[n("span",{class:"token keyword"},"from"),e(" aiohttp "),n("span",{class:"token keyword"},"import"),e(` web
`),n("span",{class:"token keyword"},"from"),e(" typing "),n("span",{class:"token keyword"},"import"),e(` Annotated
`),n("span",{class:"token keyword"},"from"),e(" taskiq "),n("span",{class:"token keyword"},"import"),e(` TaskiqDepends
`),n("span",{class:"token keyword"},"from"),e(" my_project"),n("span",{class:"token punctuation"},"."),e("tkq "),n("span",{class:"token keyword"},"import"),e(` broker

`),n("span",{class:"token decorator annotation punctuation"},[e("@broker"),n("span",{class:"token punctuation"},"."),e("task")]),e(`
`),n("span",{class:"token keyword"},"async"),e(),n("span",{class:"token keyword"},"def"),e(),n("span",{class:"token function"},"my_task"),n("span",{class:"token punctuation"},"("),e("app"),n("span",{class:"token punctuation"},":"),e(" Annotated"),n("span",{class:"token punctuation"},"["),e("web"),n("span",{class:"token punctuation"},"."),e("Application"),n("span",{class:"token punctuation"},","),e(" TaskiqDepends"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),e(`
    `),n("span",{class:"token punctuation"},"."),n("span",{class:"token punctuation"},"."),n("span",{class:"token punctuation"},"."),e(`

`)])]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),q=n("div",{class:"language-python line-numbers-mode","data-ext":"py","data-title":"py"},[n("pre",{class:"language-python"},[n("code",null,[n("span",{class:"token keyword"},"from"),e(" aiohttp "),n("span",{class:"token keyword"},"import"),e(` web
`),n("span",{class:"token keyword"},"from"),e(" taskiq "),n("span",{class:"token keyword"},"import"),e(` TaskiqDepends
`),n("span",{class:"token keyword"},"from"),e(" my_project"),n("span",{class:"token punctuation"},"."),e("tkq "),n("span",{class:"token keyword"},"import"),e(` broker

`),n("span",{class:"token decorator annotation punctuation"},[e("@broker"),n("span",{class:"token punctuation"},"."),e("task")]),e(`
`),n("span",{class:"token keyword"},"async"),e(),n("span",{class:"token keyword"},"def"),e(),n("span",{class:"token function"},"my_task"),n("span",{class:"token punctuation"},"("),e("app"),n("span",{class:"token punctuation"},":"),e(" web"),n("span",{class:"token punctuation"},"."),e("Application "),n("span",{class:"token operator"},"="),e(" TaskiqDepends"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},":"),e(`
    `),n("span",{class:"token punctuation"},"."),n("span",{class:"token punctuation"},"."),n("span",{class:"token punctuation"},"."),e(`

`)])]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),A=n("p",null,"In this example, we depend on the current application. We can use its state in a current task or any other dependency. We can take db_pool from your application's state, which is the same pool, as the one you've created on AiohTTP's startup. But this application is only a mock of your application. It has correct types and all your variables that you filled on startup, but it doesn't handle any request. This integration adds two main dependencies:",-1),x=n("ul",null,[n("li",null,"web.Application - current application."),n("li",null,"web.Request - mocked request. This request only exists to be able to use the same dependencies.")],-1),P={href:"https://github.com/taskiq-python/examples",target:"_blank",rel:"noopener noreferrer"},H=p(`<h2 id="testing" tabindex="-1"><a class="header-anchor" href="#testing"><span>Testing</span></a></h2><p>Writing tests for AioHTTP with taskiq is as easy as writing tests for the aiohttp application. The only difference is that, if you want to use InMemoryBroker, then you need to add context for dependency injection. It&#39;s easier to call <code>populate_context</code> when creating a <code>test_client</code> fixture.</p><div class="language-python line-numbers-mode" data-ext="py" data-title="py"><pre class="language-python"><code><span class="token keyword">import</span> taskiq_aiohttp

<span class="token decorator annotation punctuation">@pytest<span class="token punctuation">.</span>fixture</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">test_client</span><span class="token punctuation">(</span>
    app<span class="token punctuation">:</span> web<span class="token punctuation">.</span>Application<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> AsyncGenerator<span class="token punctuation">[</span>TestClient<span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    Create a test client.

    This function creates a TestServer
    and a test client for the application.

    Also this fixture populates context
    with needed variables.

    :param app: current application.
    :yield: ready to use client.
    &quot;&quot;&quot;</span>
    loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_running_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
    server <span class="token operator">=</span> TestServer<span class="token punctuation">(</span>app<span class="token punctuation">)</span>
    client <span class="token operator">=</span> TestClient<span class="token punctuation">(</span>server<span class="token punctuation">,</span> loop<span class="token operator">=</span>loop<span class="token punctuation">)</span>

    <span class="token keyword">await</span> client<span class="token punctuation">.</span>start_server<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># This is important part.</span>
    <span class="token comment"># Since InMemoryBroker doesn&#39;t</span>
    <span class="token comment"># run as a worker process, we have to populate</span>
    <span class="token comment"># broker&#39;s context by hand.</span>
    taskiq_aiohttp<span class="token punctuation">.</span>populate_context<span class="token punctuation">(</span>
        broker<span class="token operator">=</span>broker<span class="token punctuation">,</span>
        server<span class="token operator">=</span>server<span class="token punctuation">.</span>runner<span class="token punctuation">.</span>server<span class="token punctuation">,</span>
        app<span class="token operator">=</span>app<span class="token punctuation">,</span>
        loop<span class="token operator">=</span>loop<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    <span class="token keyword">yield</span> client

    broker<span class="token punctuation">.</span>custom_dependency_context <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">await</span> client<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,3);function j(D,W){const s=l("ExternalLinkIcon"),c=l("Tabs");return d(),u("div",null,[m,v,h,n("p",null,[e("We created a library "),n("a",b,[e("aiohttp-deps"),a(s)]),e(" to add FastAPI-like dependency injection in AioHTTP.")]),y,n("p",null,[e("You can read more about dependency injection and available dependencies in the project's "),n("a",g,[e("README.md"),a(s)]),e(".")]),f,n("p",null,[e("We highly recommend using aiohttp with aiohttp-deps because it allows us to reuse the same dependencies for your handlers and tasks. First of all, you should install the "),n("a",_,[e("taskiq-aiohttp"),a(s)]),e(" library.")]),T,a(c,{id:"37",data:[{id:"Annotated 3.10+"},{id:"default values"}]},{title0:t(({value:i,isActive:o})=>[e("Annotated 3.10+")]),title1:t(({value:i,isActive:o})=>[e("default values")]),tab0:t(({value:i,isActive:o})=>[w]),tab1:t(({value:i,isActive:o})=>[q]),_:1}),A,x,n("p",null,[e("You can find more detailed examples in the "),n("a",P,[e("examples repo"),a(s)]),e(".")]),H])}const S=r(k,[["render",j],["__file","taskiq-with-aiohttp.html.vue"]]),N=JSON.parse('{"path":"/framework_integrations/taskiq-with-aiohttp.html","title":"Taskiq + AioHTTP","lang":"en-US","frontmatter":{"order":2,"description":"Taskiq + AioHTTP AioHTTP is a framework for building robust applications. We created several libraries to make the experience with AioHTTP even better. Dependency injection for ...","head":[["meta",{"property":"og:url","content":"https://taskiq-python.github.io/framework_integrations/taskiq-with-aiohttp.html"}],["meta",{"property":"og:site_name","content":"Taskiq"}],["meta",{"property":"og:title","content":"Taskiq + AioHTTP"}],["meta",{"property":"og:description","content":"Taskiq + AioHTTP AioHTTP is a framework for building robust applications. We created several libraries to make the experience with AioHTTP even better. Dependency injection for ..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"en-US"}],["meta",{"property":"og:updated_time","content":"2024-02-05T23:36:31.000Z"}],["meta",{"property":"article:modified_time","content":"2024-02-05T23:36:31.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Taskiq + AioHTTP\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2024-02-05T23:36:31.000Z\\",\\"author\\":[]}"]]},"headers":[{"level":2,"title":"Adding taskiq integration","slug":"adding-taskiq-integration","link":"#adding-taskiq-integration","children":[]},{"level":2,"title":"Testing","slug":"testing","link":"#testing","children":[]}],"git":{"createdTime":1707176191000,"updatedTime":1707176191000,"contributors":[{"name":"Pavel Kirilin","email":"win10@list.ru","commits":1}]},"filePathRelative":"framework_integrations/taskiq-with-aiohttp.md","localizedDate":"February 5, 2024","autoDesc":true,"excerpt":"\\n<p>AioHTTP is a framework for building robust applications. We created several libraries to make the experience with AioHTTP even better.</p>\\n<h1>Dependency injection for AioHTTP</h1>\\n<p>We created a library <a href=\\"https://pypi.org/project/aiohttp-deps/\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">aiohttp-deps</a> to add FastAPI-like dependency injection in AioHTTP.</p>"}');export{S as comp,N as data};
